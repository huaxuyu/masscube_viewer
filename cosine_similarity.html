<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>MS/MS Mirror Plot & Similarity</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <style>
      body {
        font-family: Arial, Helvetica, sans-serif;
        margin: 60px;
        margin-left: 120px;
        max-width: 1100px;
      }
      h1 {
        font-size: 1.6rem;
        margin-bottom: 1rem;
      }
      textarea {
        width: 100%;
        height: 120px;
        font-family: Arial, Helvetica, sans-serif;
        font-size: 0.9rem;
        box-sizing: border-box;
      }
      .row {
        display: flex;
        gap: 16px;
        margin-bottom: 16px;
        flex-wrap: wrap;
      }
      .col {
        flex: 1 1 0;
        min-width: 260px;
      }
      label {
        font-weight: 600;
        display: block;
        margin-bottom: 4px;
      }
      .controls {
        margin: 10px 0 16px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.2rem;
        flex-wrap: wrap;
      }
      input[type="number"] {
        width: 100px;
        padding: 4px 6px;
        font-family: Arial;
        font-size: 0.9rem;
      }
      button {
        padding: 6px 12px;
        border-radius: 4px;
        border: 1px solid #ccc;
        background: #f5f5f5;
        cursor: pointer;
        font-size: 0.9rem;
        font-family: Arial;
      }
      button:hover {
        background: #e8e8e8;
      }
      #result {
        font-weight: 600;
      }
      #plot {
        width: 100%;
        height: 500px;
      }
    </style>
  </head>

  <body>
    <h1>MS/MS Mirror Plot & Cosine Similarity</h1>

    <div class="row">
      <div class="col">
        <label>Spectrum A</label>
        <textarea
          id="specA"
          placeholder="Format: mz;intensity|mz;intensity|..."
        ></textarea>
      </div>
      <div class="col">
        <label>Spectrum B</label>
        <textarea
          id="specB"
          placeholder="Format: mz;intensity|mz;intensity|..."
        ></textarea>
      </div>
    </div>

    <div class="controls">
      <label>m/z tolerance (Da):</label>
      <input type="number" id="tol" value="0.01" step="0.0001" />
      <button id="btn-run" style="background-color: rgba(164, 215, 234, 1)">
        Plot & Compute Similarity
      </button>
      <button id="btn-example">Load example</button>
      <span id="result"></span>
    </div>

    <div id="plot"></div>

    <script>
      // =======================
      // PARSE SPECTRA
      // =======================
      // Format: mz;intensity|mz;intensity|mz;intensity
      function parseSpectrum(text) {
        const peaks = [];
        const parts = text.split("|");

        for (let p of parts) {
          p = p.trim();
          if (!p) continue;
          const vals = p.split(";");
          if (vals.length < 2) continue;

          const mz = parseFloat(vals[0]);
          const intensity = parseFloat(vals[1]);
          if (!isNaN(mz) && !isNaN(intensity)) peaks.push({ mz, intensity });
        }

        peaks.sort((a, b) => a.mz - b.mz);
        return peaks;
      }

      // =======================
      // COSINE SIMILARITY
      // intensity-priority 1:1 matching
      // =======================
      function cosineSimilarityTolerance(A, B, tol) {
        if (A.length === 0 || B.length === 0) return 0.0;

        const AA = [...A].sort((a, b) => b.intensity - a.intensity);
        const BB = [...B].sort((a, b) => b.intensity - a.intensity);

        const usedB = new Array(BB.length).fill(false);

        let dot = 0.0;
        let normA = 0.0;
        let normB = 0.0;

        for (const p of AA) normA += p.intensity * p.intensity;
        for (const p of BB) normB += p.intensity * p.intensity;

        if (normA === 0 || normB === 0) return 0.0;

        for (let i = 0; i < AA.length; i++) {
          const mzA = AA[i].mz;
          const intA = AA[i].intensity;

          let bestK = -1;
          let bestInt = -1;

          for (let k = 0; k < BB.length; k++) {
            if (usedB[k]) continue;
            const mzB = BB[k].mz;
            const intB = BB[k].intensity;
            if (Math.abs(mzA - mzB) <= tol && intB > bestInt) {
              bestInt = intB;
              bestK = k;
            }
          }

          if (bestK !== -1) {
            dot += intA * BB[bestK].intensity;
            usedB[bestK] = true;
          }
        }

        return dot / Math.sqrt(normA * normB);
      }

      // =======================
      // MIRROR PLOT (vertical sticks)
      // =======================
      function makeMirrorPlot(A, B) {
        if (A.length === 0 && B.length === 0) {
          Plotly.newPlot("plot", [], { title: "No data" });
          return;
        }

        let maxInt = 0;
        for (const p of A) maxInt = Math.max(maxInt, Math.abs(p.intensity));
        for (const p of B) maxInt = Math.max(maxInt, Math.abs(p.intensity));
        if (maxInt === 0) maxInt = 1;

        // Build sticks for A
        const xA = [];
        const yA = [];
        for (const p of A) {
          xA.push(p.mz, p.mz, null);
          yA.push(0, p.intensity / maxInt, null);
        }

        const traceA = {
          x: xA,
          y: yA,
          mode: "lines",
          name: "Spectrum A",
          line: { width: 2, color: "rgb(0, 0, 255)" },
        };

        // Build sticks for B (mirrored)
        const xB = [];
        const yB = [];
        for (const p of B) {
          xB.push(p.mz, p.mz, null);
          yB.push(0, -p.intensity / maxInt, null);
        }

        const traceB = {
          x: xB,
          y: yB,
          mode: "lines",
          name: "Spectrum B",
          line: { width: 2, color: "rgb(255,0,0)" },
        };

        const allMz = [...A.map((p) => p.mz), ...B.map((p) => p.mz)];

        const layout = {
          xaxis: {
            title: {
              text: "m/z",
              font: { family: "Arial", size: 28 },
              standoff: 20,
            },
            tickfont: { family: "Arial", size: 20 },
            showline: true,
            linecolor: "black",
            linewidth: 2,
            range: [0, Math.max(...allMz) + 10],
          },
          yaxis: {
            title: {
              text: "Intensity",
              font: { family: "Arial", size: 28 },
              standoff: 50,
            },
            tickfont: { family: "Arial", size: 20 },
            showline: true,
            linecolor: "black",
            linewidth: 2,

            ticks: "outside",
            ticklen: 10,
            tickwidth: 2,
            tickcolor: "black",

            showgrid: true,
            gridcolor: "lightgray",
            gridwidth: 1,
          },
          legend: {
            font: { family: "Arial", size: 20 },
          },
          margin: { t: 40, r: 20, b: 140, l: 80 },
          font: { family: "Arial" },
        };

        Plotly.newPlot("plot", [traceA, traceB], layout);
      }

      // =======================
      // EXAMPLE DATA
      // =======================
      document.getElementById("btn-example").addEventListener("click", () => {
        document.getElementById("specA").value =
          "100.000;1200|100.503;850|101.047;620|150.001;3000|200.100;1550";

        document.getElementById("specB").value =
          "99.995;1100|100.515;900|101.050;700|150.015;3100|199.980;1500";

        Plotly.purge("plot");
        document.getElementById("result").textContent = "";
      });

      // =======================
      // MAIN BUTTON
      // =======================
      document.getElementById("btn-run").addEventListener("click", () => {
        const tol = parseFloat(document.getElementById("tol").value) || 0.01;

        const A = parseSpectrum(document.getElementById("specA").value);
        const B = parseSpectrum(document.getElementById("specB").value);

        if (A.length === 0 || B.length === 0) {
          document.getElementById("result").textContent =
            "Please enter both spectra.";
          return;
        }

        const cos = cosineSimilarityTolerance(A, B, tol);
        document.getElementById(
          "result"
        ).textContent = `Cosine similarity = ${cos.toFixed(4)}`;

        makeMirrorPlot(A, B);
      });
    </script>
  </body>
</html>
